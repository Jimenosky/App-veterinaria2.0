# ๐ฅ Diagrama del Sistema Veterinaria

## Arquitectura General

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      SISTEMA INTEGRAL                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

                    โโโโโโโโโโโโโโโโโโโโโโโโ
                    โ   Base de Datos      โ
                    โ    SQLite 3.x        โ
                    โ                      โ
                    โ  โข usuarios          โ
                    โ  โข mascotas          โ
                    โ  โข citas             โ
                    โโโโโโโโโโโโโโโโฌโโโโโโโโ
                                   โ
                    โโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโ
                    โ    BACKEND API               โ
                    โ  Node.js + Express          โ
                    โ  Puerto: 3001               โ
                    โ                             โ
                    โ  /api/v1/auth               โ
                    โ  /api/v1/mascotas           โ
                    โ  /api/v1/citas              โ
                    โโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโฌโโโโโ
                           โ          โ       โ
              โโโโโโโโโโโโโโ          โ       โโโโโโโโโโโโ
              โ                       โ                  โ
    โโโโโโโโโโโผโโโโโโโโโโโ  โโโโโโโโโโผโโโโโโโโโ  โโโโโโโโผโโโโโโโโโโ
    โ  ADMIN PANEL       โ  โ   APP MรVIL     โ  โ   WEB BROWSER  โ
    โ  React + Vite     โ  โ React Native    โ  โ   (Testing)    โ
    โ  Puerto: 5173     โ  โ Expo            โ  โ Localhost:8081 โ
    โ                    โ  โ Puerto: 8081    โ  โ                โ
    โ โข Dashboard       โ  โ                 โ  โ โข Test API     โ
    โ โข Tabla Citas     โ  โ โข Login         โ  โ โข Ver datos    โ
    โ โข Tabla Usuarios  โ  โ โข Perfil        โ  โ                โ
    โ โข Reportes *      โ  โ โข Home          โ  โ                โ
    โ                    โ  โ โข Logout        โ  โ                โ
    โโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโ

         Administrador         Clientes              Desarrollador
              (1)              (N usuarios)           (Testing)
```

## Flujo de Datos

### 1. Registro e Inicio de Sesiรณn

```
โโโโโโโโโโโโโโโโโโโโโโโ
โ  Usuario Nuevo      โ
โ                     โ
โ Email: usuario@...  โ
โ Password: ****      โ
โโโโโโโโโโโโฌโโโโโโโโโโโ
           โ
           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  POST /api/v1/auth/register         โ
โ  Envรญa: email, password, nombre     โ
โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
           โ
           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Backend valida y hashea password   โ
โ  Inserta en tabla usuarios          โ
โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
           โ
           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Retorna: {success, user, token}    โ
โ  Token JWT guardado en AsyncStorage โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 2. Flujo de Cita

```
โโโโโโโโโโโโโโโโโโโโโโโโ
โ  Cliente en App      โ
โ  Selecciona mascota  โ
โ  Elige fecha/hora    โ
โโโโโโโโโโโฌโโโโโโโโโโโโโ
          โ
          โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  POST /api/v1/citas                  โ
โ  Con token autorizaciรณn              โ
โโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ
          โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Backend:                            โ
โ  โข Valida token                      โ
โ  โข Verifica mascota del usuario      โ
โ  โข Verifica disponibilidad horaria   โ
โ  โข Inserta en tabla citas            โ
โโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ
          โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Admin ve nueva cita en dashboard    โ
โ  Estado: PENDIENTE                   โ
โโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ
          โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Admin edita anotaciones y confirma  โ
โ  PUT /api/v1/citas/:id               โ
โโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ
          โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Cliente ve estado actualizado       โ
โ  en su app (si tiene UI definida)   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Autenticaciรณn con JWT

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  1. Usuario hace login          โ
โ     POST /auth/login            โ
โ     {email, password}           โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  2. Backend valida credenciales โ
โ     โข Busca usuario por email   โ
โ     โข Compara password hasheado โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  3. Genera JWT Token                     โ
โ     Header: {typ: "JWT", alg: "HS256"}   โ
โ     Payload: {id, email, rol, nombre}    โ
โ     Signature: JWT_SECRET                โ
โ     Expira en: 7 dรญas                    โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  4. Cliente almacena token               โ
โ     AsyncStorage: token                  โ
โ     AsyncStorage: user                   โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  5. En siguientes requests               โ
โ     Header: Authorization: Bearer TOKEN  โ
โ     Backend valida en middleware         โ
โ     Si es vรกlido: continรบa               โ
โ     Si expira: 401 Unauthorized          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Roles y Permisos

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           CLIENTE (Rol: "cliente")       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โ Ver su perfil                          โ
โ โ Editar su perfil                       โ
โ โ Ver sus mascotas                       โ
โ โ Crear mascotas                         โ
โ โ Editar sus mascotas                    โ
โ โ Crear sus citas                        โ
โ โ Ver sus citas                          โ
โ โ Cancelar sus citas (si pendiente)      โ
โ โ Ver otros clientes                     โ
โ โ Acceder a admin panel                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           ADMIN (Rol: "admin")           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โ Ver todos los usuarios                 โ
โ โ Ver todas las citas                    โ
โ โ Editar estado de citas                 โ
โ โ Agregar notas a citas                  โ
โ โ Eliminar citas                         โ
โ โ Ver estadรญsticas                       โ
โ โ Acceder a admin panel                  โ
โ โ Eliminar usuarios                      โ
โ (Otras acciones limitadas)               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Estados de Cita

```
                    โโโโโโโโโโโโโโโ
                    โ   CREADA    โ
                    โ (pendiente)  โ
                    โโโโโโโโฌโโโโโโโ
                           โ
            โโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโ
            โ                             โ
            โผ                             โผ
    โโโโโโโโโโโโโโโโ              โโโโโโโโโโโโโโโโโโ
    โ CONFIRMADA   โ              โ  CANCELADA     โ
    โ (por admin)  โ              โ (por cliente)  โ
    โโโโโโโโฌโโโโโโโโ              โโโโโโโโโโโโโโโโโโ
           โ
           โผ
    โโโโโโโโโโโโโโโโ
    โ COMPLETADA   โ
    โ (por admin)  โ
    โโโโโโโโโโโโโโโโ

Estados:
โข pendiente    = Iniciada, esperando confirmaciรณn del admin
โข confirmada   = Admin confirmรณ que ocurrirรก
โข completada   = La cita ya ocurriรณ
โข cancelada    = Usuario cancelรณ antes de confirmaciรณn
```

## Tabla de Citas - Campos

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           TABLA: citas                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ id                 | PK Integer            โ
โ usuario_id         | FK โ usuarios.id      โ
โ mascota_id         | FK โ mascotas.id      โ
โ fecha              | DATE (2026-02-15)     โ
โ hora               | TIME (14:30:00)       โ
โ tipo_servicio      | TEXT (Vacuna, Corte) โ
โ descripcion        | TEXT (Notas)          โ
โ estado             | ENUM (pendiente...)   โ
โ costo              | REAL (100.50)         โ
โ notas_admin        | TEXT (Admin notes)    โ
โ fecha_creacion     | DATETIME              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Ejemplo de cita:
{
  id: 1,
  usuario_id: 2,
  mascota_id: 3,
  fecha: "2026-02-20",
  hora: "15:30",
  tipo_servicio: "Vacunaciรณn anual",
  descripcion: "Vacuna contra rabia y moquillo",
  estado: "confirmada",
  costo: 75.00,
  notas_admin: "Perro muy tranquilo, buena actitud",
  fecha_creacion: "2026-02-09T10:30:00"
}
```

## Tabla de Usuarios - Campos

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           TABLA: usuarios                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ id                 | PK Integer            โ
โ nombre             | TEXT (Juan Pรฉrez)     โ
โ email              | UNIQUE TEXT           โ
โ password           | TEXT (hasheado)       โ
โ telefono           | TEXT (opcional)       โ
โ direccion          | TEXT (opcional)       โ
โ rol                | ENUM (cliente/admin)  โ
โ estado             | ENUM (activo...)      โ
โ fecha_creacion     | DATETIME              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Ejemplo de usuario:
{
  id: 2,
  nombre: "Juan Pรฉrez",
  email: "juan@ejemplo.com",
  password: "$2a$10$hashedpassword...",
  telefono: "+34-123-456-789",
  direccion: "Calle Principal 123",
  rol: "cliente",
  estado: "activo",
  fecha_creacion: "2026-02-09T08:00:00"
}
```

## Tabla de Mascotas - Campos

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           TABLA: mascotas                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ id                 | PK Integer            โ
โ nombre             | TEXT (Firulais)       โ
โ tipo               | TEXT (Perro/Gato)     โ
โ raza               | TEXT (Pastor Alemรกn)  โ
โ edad               | INTEGER (aรฑos)        โ
โ peso               | REAL (kg)             โ
โ usuario_id         | FK โ usuarios.id      โ
โ fecha_creacion     | DATETIME              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Ejemplo de mascota:
{
  id: 3,
  nombre: "Firulais",
  tipo: "Perro",
  raza: "Pastor Alemรกn",
  edad: 5,
  peso: 35.5,
  usuario_id: 2,
  fecha_creacion: "2026-02-09T09:15:00"
}
```

## Flujo de Sincronizaciรณn

```
CLIENTE APP                  BACKEND                 ADMIN PANEL
    โ                           โ                        โ
    โโโโ POST /citas โโโโโโโโโโ>โ                        โ
    โ   (Nueva cita)            โ                        โ
    โ                           โโโโโโโโ                 โ
    โ                           โ      โINSERT            โ
    โ                           โ<โโโโโโ                 โ
    โ<โโโโ 201 Created โโโโโโโโโโ                        โ
    โ  {id, estado}             โ                        โ
    โ                       โโโโโดโโโโ                     โ
    โ                       โ Datos โ                     โ
    โ                       โ SQLiteโ                     โ
    โ                       โโโโโฌโโโโ                     โ
    โ                           โโ GET /citas/admin/all ->โ
    โ                           โ<โ Realiza polling       โ
    โ                           โ                        โโโ TABLA ACTUALIZA
    โ                           โ   Muestra nueva cita   โ
    โ                           โ<โโโโโโโโโโโโโโโโโโโโโโโโ
    โ                           โ                        โ
    โ<โโโโโ GET /citas/user โโโโโ                        โ
    โ   (Sincroniza state)      โ                        โ
    โ                    STATE SINCRONIZADO
    โ

La sincronizaciรณn es:
โ En tiempo real (polling del admin cada 5 segundos)
โ Bidireccional (app puede actualizar cita)
โ Consistente (una sola fuente de verdad: SQLite)
```

## Seguridad - Flujo de Validaciรณn

```
Request Entrante
    โ
    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  1. Validar Formato     โ
โ  โข Content-Type JSON    โ
โ  โข Parseable            โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  2. Validar Datos                   โ
โ  โข Email vรกlido                     โ
โ  โข Password > 6 caracteres          โ
โ  โข Campos requeridos                โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  3. Autenticaciรณn (si lo requiere)  โ
โ  โข Token presente                   โ
โ  โข Token vรกlido                     โ
โ  โข Token no expirado                โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  4. Autorizaciรณn (Rol)              โ
โ  โข Usuario es admin (si requiere)   โ
โ  โข Datos pertenecen al usuario      โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  5. Ejecutar Funciรณn Segura         โ
โ  โข Hash passwords con bcryptjs      โ
โ  โข Validar en BD                    โ
โ  โข Retornar resultados              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Configuraciรณn de Variables de Entorno

```
โโโโโโโโโโโโโโโโโโโ .env โโโโโโโโโโโโโโโโโโโ
# Backend Configuration

PORT=3001
NODE_ENV=development

# JWT Configuration
JWT_SECRET=tu_clave_secreta_super_segura_2025

# Database Configuration
DATABASE_PATH=./database.sqlite

# Optional: Para producciรณn
# DATABASE_URL=postgresql://...
# PORT=8080
# NODE_ENV=production
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Flujo de Ediciรณn de Perfil

```
Usuario en App
    โ
    โโโโโโโโโโโฌโโโโโโโโโโ
              โ         โ
              โผ         โผ
         Ver Datos   Editar Modo
              โ         โ
              โ         โผ
              โ    Llenar Formulario
              โ    โข Nombre
              โ    โข Telรฉfono
              โ    โข Direcciรณn
              โ    โข Password (opcional)
              โ         โ
              โ         โผ
              โ    Enviar PUT
              โ    /api/v1/auth/profile
              โ    Header: { Authorization: Bearer TOKEN }
              โ    Body: { nombre, telefono, direccion }
              โ         โ
              โโโโโโโโโ>โ<โโโโโโโ
                        โผ       
                   Backend:
                   โข Valida token
                   โข Si password: hashea
                   โข UPDATE usuarios SET...
                   โข Retorna: usuario actualizado
                        โ
                        โผ
               App actualiza AsyncStorage
               โข AsyncStorage.setItem('user', JSON.stringify(newUser))
                        โ
                        โผ
               UI muestra datos nuevos
```

## Ejemplo de Request/Response

### Login

```
โ REQUEST โ
POST http://localhost:3001/api/v1/auth/login
Content-Type: application/json

{
  "email": "admin@veterinaria.com",
  "password": "password123"
}

โ RESPONSE โ
HTTP/1.1 200 OK
Content-Type: application/json

{
  "success": true,
  "message": "Login exitoso",
  "data": {
    "user": {
      "id": 1,
      "nombre": "Administrador",
      "email": "admin@veterinaria.com",
      "telefono": "+34-123-456-789",
      "rol": "admin"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

### Crear Cita

```
โ REQUEST โ
POST http://localhost:3001/api/v1/citas
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

{
  "mascota_id": 3,
  "fecha": "2026-02-20",
  "hora": "15:30",
  "tipo_servicio": "Vacunaciรณn",
  "descripcion": "Vacuna anual"
}

โ RESPONSE โ
HTTP/1.1 201 Created
Content-Type: application/json

{
  "success": true,
  "message": "Cita creada exitosamente",
  "data": {
    "id": 5,
    "usuario_id": 2,
    "mascota_id": 3,
    "fecha": "2026-02-20",
    "hora": "15:30",
    "tipo_servicio": "Vacunaciรณn",
    "estado": "pendiente"
  }
}
```

## Notas Finales

โจ **Este diagrama describe el flujo completo del sistema**

Cada componente interactรบa mediante:
- ๐ Autenticaciรณn JWT
- ๐ก API REST
- ๐พ SQLite Database
- ๐ Sincronizaciรณn bidireccional
- โ Validaciรณn en cada capa

**Resultado:** Un sistema profesional, seguro y totalmente funcional! ๐
